name: CI/CD - Maven Build ve AWS EC2 Deployment

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: isinolsun_db
          MYSQL_ROOT_PASSWORD: root
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Kodu Ã‡ek
        uses: actions/checkout@v4

      - name: JDK 17 Kurulumu
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Maven ile Derle
        run: mvn -B clean package -DskipTests

      - name: DosyayÄ± Sunucuya GÃ¶nder (SCP)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "target/isinolsun-0.0.1-SNAPSHOT.jar"
          target: "/home/ubuntu/"

      - name: UygulamayÄ± Sunucuda BaÅŸlat (SSH)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 20m
          script: |
            echo "Port 8080 temizleniyor..."
          
            fuser -k -n tcp 8080 || true
            
            echo "Temizlik yapÄ±ldÄ±, 3 saniye bekleniyor..."
            sleep 3
            
            echo "Yeni uygulama baÅŸlatÄ±lÄ±yor..."
            nohup java -jar /home/ubuntu/target/isinolsun-0.0.1-SNAPSHOT.jar > /home/ubuntu/log.txt 2>&1 &
            
            echo "ISLEM TAMAM! Gecmis olsun ðŸš€"
